import React, { useState } from 'react';

interface ServerSetupProps {
  onBack: () => void;
}

export const ServerSetup: React.FC<ServerSetupProps> = ({ onBack }) => {
  const [activeTab, setActiveTab] = useState<'sql' | 'node'>('node');
  const [copied, setCopied] = useState(false);

  const copyToClipboard = (text: string) => {
    navigator.clipboard.writeText(text);
    setCopied(true);
    setTimeout(() => setCopied(false), 2000);
  };

  const sqlCode = `
-- Crie a tabela no seu banco PostgreSQL
CREATE TABLE IF NOT EXISTS membros (
  id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  foto TEXT, -- Armazena Base64 ou URL da imagem
  nome_completo TEXT NOT NULL,
  login TEXT NOT NULL UNIQUE,
  data_nascimento DATE NOT NULL,
  estado_civil TEXT NOT NULL,
  nome_conjuge TEXT,
  data_casamento DATE,
  telefone TEXT NOT NULL,
  email TEXT NOT NULL,
  cep TEXT NOT NULL,
  logradouro TEXT NOT NULL,
  bairro TEXT NOT NULL,
  cidade TEXT NOT NULL,
  uf TEXT NOT NULL,
  possui_veiculo BOOLEAN NOT NULL DEFAULT false,
  modelo_veiculo TEXT,
  paroquia TEXT NOT NULL,
  comunidade TEXT NOT NULL,
  setor TEXT NOT NULL,
  funcao TEXT NOT NULL,
  data_ingresso DATE NOT NULL DEFAULT CURRENT_DATE,
  observacoes TEXT,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT timezone('utc'::text, now())
);
`;

  const nodeCode = `
// server.js - Backend para Pastoral Familiar
// Instale dependências: npm install express pg cors body-parser helmet dotenv

require('dotenv').config();
const express = require('express');
const { Pool } = require('pg');
const cors = require('cors');
const helmet = require('helmet');

const app = express();
const port = process.env.PORT || 3000;

// Configuração do PostgreSQL (Ajuste para seu Home Server)
const pool = new Pool({
  user: process.env.DB_USER || 'postgres',
  host: process.env.DB_HOST || 'localhost',
  database: process.env.DB_NAME || 'pastoral_db',
  password: process.env.DB_PASSWORD || 'sua_senha',
  port: process.env.DB_PORT || 5432,
});

app.use(helmet());
app.use(cors()); // Permite conexões do Vercel
app.use(express.json({ limit: '10mb' })); // Limite alto para upload de foto base64

// Rota de Cadastro de Agente
app.post('/api/membros', async (req, res) => {
  const client = await pool.connect();
  try {
    const data = req.body;
    
    const query = \`
      INSERT INTO membros (
        foto, nome_completo, login, data_nascimento, estado_civil,
        nome_conjuge, data_casamento, telefone, email, cep,
        logradouro, bairro, cidade, uf, possui_veiculo,
        modelo_veiculo, paroquia, comunidade, setor, funcao,
        data_ingresso, observacoes
      ) VALUES (
        $1, $2, $3, $4, $5, $6, $7, $8, $9, $10,
        $11, $12, $13, $14, $15, $16, $17, $18, $19, $20,
        $21, $22
      ) RETURNING id;
    \`;

    const values = [
      data.foto, data.nome_completo, data.login, data.data_nascimento, data.estado_civil,
      data.nome_conjuge, data.data_casamento || null, data.telefone, data.email, data.cep,
      data.logradouro, data.bairro, data.cidade, data.uf, data.possui_veiculo,
      data.modelo_veiculo, data.paroquia, data.comunidade, data.setor, data.funcao,
      data.data_ingresso, data.observacoes
    ];

    const result = await client.query(query, values);
    res.status(201).json({ success: true, id: result.rows[0].id });

  } catch (err) {
    console.error('Erro no cadastro:', err);
    res.status(500).json({ error: 'Erro ao salvar dados', details: err.message });
  } finally {
    client.release();
  }
});

// Rota de Teste
app.get('/', (req, res) => {
  res.send('API Pastoral Familiar Online ✝️');
});

app.listen(port, () => {
  console.log(\`Servidor rodando em http://localhost:\${port}\`);
});
`;

  return (
    <div className="p-6 h-full flex flex-col text-slate-100 animate-fade-in">
       {/* Header */}
       <div className="flex items-center justify-between mb-6">
        <div className="flex items-center gap-4">
          <button onClick={onBack} className="p-2 rounded-full bg-white/10 hover:bg-white/20 backdrop-blur text-white transition-all">
            <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M15 19l-7-7 7-7" /></svg>
          </button>
          <h2 className="text-xl font-bold">Configuração do Backend</h2>
        </div>
      </div>

      <div className="bg-blue-900/30 border border-blue-500/30 rounded-xl p-4 mb-6 flex items-start gap-3">
        <div className="mt-1">
             <svg className="w-5 h-5 text-blue-300" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
        </div>
        <p className="text-sm text-blue-200">
          Para que este aplicativo (Frontend Vercel) funcione com seu banco em casa, copie e rode o código abaixo no seu servidor doméstico.
          <br/><span className="text-xs opacity-70 mt-1 block">Necessário instalar Node.js e PostgreSQL.</span>
        </p>
      </div>

      {/* Tabs */}
      <div className="flex gap-2 mb-4">
        <button 
          onClick={() => setActiveTab('node')}
          className={`flex-1 py-3 rounded-lg text-sm font-semibold transition-colors ${activeTab === 'node' ? 'bg-green-600 text-white shadow-lg shadow-green-900/20' : 'bg-white/5 text-slate-400 hover:bg-white/10'}`}
        >
          Node.js API
        </button>
        <button 
          onClick={() => setActiveTab('sql')}
          className={`flex-1 py-3 rounded-lg text-sm font-semibold transition-colors ${activeTab === 'sql' ? 'bg-blue-600 text-white shadow-lg shadow-blue-900/20' : 'bg-white/5 text-slate-400 hover:bg-white/10'}`}
        >
          Banco de Dados (SQL)
        </button>
      </div>

      {/* Code Area */}
      <div className="flex-1 relative bg-[#0d1117] rounded-xl border border-white/10 overflow-hidden flex flex-col shadow-inner">
        <div className="absolute top-0 right-0 p-3 z-10">
          <button 
            onClick={() => copyToClipboard(activeTab === 'node' ? nodeCode : sqlCode)}
            className="px-3 py-1.5 bg-white/10 hover:bg-white/20 rounded text-xs text-white border border-white/10 backdrop-blur transition-all active:scale-95 flex items-center gap-2"
          >
            {copied ? (
                <>
                <svg className="w-3 h-3 text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M5 13l4 4L19 7" /></svg>
                Copiado!
                </>
            ) : (
                <>
                <svg className="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M8 5H6a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2v-1M8 5a2 2 0 002 2h2a2 2 0 002-2M8 5a2 2 0 012-2h2a2 2 0 012 2m0 0h2a2 2 0 012 2v3m2 4H10m0 0l3-3m-3 3l3 3" /></svg>
                Copiar
                </>
            )}
          </button>
        </div>
        
        <pre className="flex-1 p-6 overflow-auto custom-scrollbar text-xs md:text-sm font-mono text-blue-100 leading-relaxed">
          <code>
            {activeTab === 'node' ? nodeCode : sqlCode}
          </code>
        </pre>
      </div>
      
      <p className="text-center text-xs text-slate-500 mt-4">
        Recomendação: Use <strong>Cloudflare Tunnel</strong> para expor a porta 3000 de forma segura sem abrir portas no roteador.
      </p>

    </div>
  );
};